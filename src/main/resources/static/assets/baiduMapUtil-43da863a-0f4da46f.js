import{a$ as C,b0 as Z,b1 as B,b2 as T,b3 as x,b4 as E,b5 as _,ad as R}from"./index-168435c7.js";import{e as N,a as z}from"./api-639c460b.js";function i(t,o){this._bmap=t,this.dimensions=["lng","lat"],this._mapOffset=[0,0],this._api=o,this._projection=new BMap.MercatorProjection}i.prototype.type="bmap";i.prototype.dimensions=["lng","lat"];i.prototype.setZoom=function(t){this._zoom=t};i.prototype.setCenter=function(t){this._center=this._projection.lngLatToPoint(new BMap.Point(t[0],t[1]))};i.prototype.setMapOffset=function(t){this._mapOffset=t};i.prototype.getBMap=function(){return this._bmap};i.prototype.dataToPoint=function(t){var o=new BMap.Point(t[0],t[1]),e=this._bmap.pointToOverlayPixel(o),a=this._mapOffset;return[e.x-a[0],e.y-a[1]]};i.prototype.pointToData=function(t){var o=this._mapOffset;return t=this._bmap.overlayPixelToPoint({x:t[0]+o[0],y:t[1]+o[1]}),[t.lng,t.lat]};i.prototype.getViewRect=function(){var t=this._api;return new B(0,0,t.getWidth(),t.getHeight())};i.prototype.getRoamTransform=function(){return T()};i.prototype.prepareCustoms=function(){var t=this.getViewRect();return{coordSys:{type:"bmap",x:t.x,y:t.y,width:t.width,height:t.height},api:{coord:x(this.dataToPoint,this),size:x(L,this)}}};i.prototype.convertToPixel=function(t,o,e){return this.dataToPoint(e)};i.prototype.convertFromPixel=function(t,o,e){return this.pointToData(e)};function L(t,o){return o=o||[0,0],E([0,1],function(e){var a=o[e],n=t[e]/2,m=[],c=[];return m[e]=a-n,c[e]=a+n,m[1-e]=c[1-e]=o[1-e],Math.abs(this.dataToPoint(m)[e]-this.dataToPoint(c)[e])},this)}var b;i.dimensions=i.prototype.dimensions;function V(){function t(o){this._root=o}return t.prototype=new BMap.Overlay,t.prototype.initialize=function(o){return o.getPanes().labelPane.appendChild(this._root),this._root},t.prototype.draw=function(){},t}i.create=function(t,o){var e,a=o.getDom();return t.eachComponent("bmap",function(n){var m=o.getZr().painter,c=m.getViewportRoot();if(typeof BMap>"u")throw new Error("BMap api is not loaded");if(b=b||V(),e)throw new Error("Only one bmap component can exist");var r;if(!n.__bmap){var p=a.querySelector(".ec-extension-bmap");p&&(c.style.left="0px",c.style.top="0px",a.removeChild(p)),p=document.createElement("div"),p.className="ec-extension-bmap",p.style.cssText="position:absolute;width:100%;height:100%",a.appendChild(p);var s=n.get("mapOptions");s&&(s=_(s),delete s.mapType),r=n.__bmap=new BMap.Map(p,s);var v=new b(c);r.addOverlay(v),m.getViewportRootOffset=function(){return{offsetLeft:0,offsetTop:0}}}r=n.__bmap;var l=n.get("center"),f=n.get("zoom");if(l&&f){var u=r.getCenter(),d=r.getZoom(),h=n.centerOrZoomChanged([u.lng,u.lat],d);if(h){var w=new BMap.Point(l[0],l[1]);r.centerAndZoom(w,f)}}e=new i(r,o),e.setMapOffset(n.__mapOffset||[0,0]),e.setZoom(f),e.setCenter(l),n.coordinateSystem=e}),t.eachSeries(function(n){n.get("coordinateSystem")==="bmap"&&(n.coordinateSystem=e)}),e&&[e]};function D(t,o){return t&&o&&t[0]===o[0]&&t[1]===o[1]}N({type:"bmap",getBMap:function(){return this.__bmap},setCenterAndZoom:function(t,o){this.option.center=t,this.option.zoom=o},centerOrZoomChanged:function(t,o){var e=this.option;return!(D(t,e.center)&&o===e.zoom)},defaultOption:{center:[104.114129,37.550339],zoom:5,mapStyle:{},mapStyleV2:{},mapOptions:{},roam:!1}});function P(t){for(var o in t)if(t.hasOwnProperty(o))return!1;return!0}z({type:"bmap",render:function(t,o,e){var a=!0,n=t.getBMap(),m=e.getZr().painter.getViewportRoot(),c=t.coordinateSystem,r=function(w,A){if(!a){var M=m.parentNode.parentNode.parentNode,y=[-parseInt(M.style.left,10)||0,-parseInt(M.style.top,10)||0],g=m.style,O=y[0]+"px",S=y[1]+"px";g.left!==O&&(g.left=O),g.top!==S&&(g.top=S),c.setMapOffset(y),t.__mapOffset=y,e.dispatchAction({type:"bmapRoam",animation:{duration:0}})}};function p(){a||e.dispatchAction({type:"bmapRoam",animation:{duration:0}})}n.removeEventListener("moving",this._oldMoveHandler),n.removeEventListener("moveend",this._oldMoveHandler),n.removeEventListener("zoomend",this._oldZoomEndHandler),n.addEventListener("moving",r),n.addEventListener("moveend",r),n.addEventListener("zoomend",p),this._oldMoveHandler=r,this._oldZoomEndHandler=p;var s=t.get("roam");s&&s!=="scale"?n.enableDragging():n.disableDragging(),s&&s!=="move"?(n.enableScrollWheelZoom(),n.enableDoubleClickZoom(),n.enablePinchToZoom()):(n.disableScrollWheelZoom(),n.disableDoubleClickZoom(),n.disablePinchToZoom());var v=t.__mapStyle,l=t.get("mapStyle")||{},f=JSON.stringify(l);JSON.stringify(v)!==f&&(P(l)||n.setMapStyle(_(l)),t.__mapStyle=JSON.parse(f));var u=t.__mapStyle2,d=t.get("mapStyleV2")||{},h=JSON.stringify(d);JSON.stringify(u)!==h&&(P(d)||n.setMapStyleV2(_(d)),t.__mapStyle2=JSON.parse(h)),a=!1}});C("bmap",i);Z({type:"bmapRoam",event:"bmapRoam",update:"updateLayout"},function(t,o){o.eachComponent("bmap",function(e){var a=e.getBMap(),n=a.getCenter();e.setCenterAndZoom([n.lng,n.lat],a.getZoom())})});async function j(t){if(!t)return{title:{text:R.t("bi.widgets.utils.baiduMapUtil.notify")}};await k(t)}function k(t){return new Promise(function(o,e){if(typeof BMap<"u")return o(BMap),!0;window.onBMapCallback=function(){o(BMap)};const a=document.createElement("script");a.type="text/javascript",a.src="https://api.map.baidu.com/api?v=3.0&ak="+t+"&callback=onBMapCallback",a.onerror=e,document.head.appendChild(a)})}export{j as R};
